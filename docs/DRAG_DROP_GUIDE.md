# ドラッグ&ドロップ機能ガイド

## 概要

MTTアプリケーションは、@dnd-kitライブラリを使用した階層的なドラッグ&ドロップ機能を提供します。

## 機能

### 1. タスクの並び替え
同じ階層（同じレベル）内でタスクをドラッグして順序を変更できます。

**例:**
- KGI A → KGI B → KGI C の順序を変更
- あるKGIの配下のKPI間で順序を変更

### 2. タスクの階層移動
異なるレベル間でタスクを移動できます。

**ルール:**
- KGI → ルートレベルのみ配置可能
- KPI → KGIの子として配置可能
- KAI → KPIの子として配置可能

**例:**
- KGI Aの配下のKPI X を KGI Bの配下に移動
- KPI Aの配下のKAI α を KPI Bの配下に移動

### 3. ビジュアルフィードバック

#### ドラッグ中のタスク表示
- **デフォルト（青）**: ドラッグ中で移動先が未定
- **緑色**: ドロップ可能な場所にホバー中
  - 緑のリング表示
  - "ドロップ可能" ラベル表示
  - チェックマークアイコン
- **赤色**: ドロップ不可能な場所にホバー中
  - 赤のリング表示
  - "ドロップ不可" ラベル表示
  - バツマークアイコン

#### ドロップ先のハイライト
- **緑のリング**: ドロップ可能なタスクにホバー中
- **赤のリング**: ドロップ不可能なタスクにホバー中

## 制約事項

### レベル制約
KGI（長期目標）→ KPI（中期指標）→ KAI（短期アクション）の階層構造を維持します。

1. **KGIタスク**
   - ルートレベルにのみ配置可能
   - 他のKGIの子にはできない
   - KPIやKAIの子にはできない

2. **KPIタスク**
   - KGIの子としてのみ配置可能
   - 他のKPIの配下に移動可能（親が変わる）
   - KAIの子にはできない

3. **KAIタスク**
   - KPIの子としてのみ配置可能
   - 他のKPIの配下に移動可能（親が変わる）
   - KGIやKAIの子にはできない

### ドロップ不可の条件
1. **自分自身にはドロップ不可**
2. **自分の子孫にはドロップ不可**
   - 例: KGI A を、KGI Aの配下のKPI Xにドロップ不可
3. **レベル制約違反はドロップ不可**
   - 例: KGI を KPI の子にはできない

## 使用方法

### 基本操作
1. タスクをクリック（またはタップ）してドラッグ開始
2. 目的の場所にホバー
   - 緑色のハイライト: ドロップ可能
   - 赤色のハイライト: ドロップ不可
3. ドロップしてタスクを移動

### 並び替え（同じ階層内）
```
元の状態:
- KGI A
- KGI B
- KGI C

KGI B を KGI C の下に移動:
- KGI A
- KGI C
- KGI B ← ここにドロップ
```

### 階層移動（別の親の子に）
```
元の状態:
- KGI A
  - KPI X
  - KPI Y
- KGI B
  - KPI Z

KPI X を KGI B の配下に移動:
- KGI A
  - KPI Y
- KGI B
  - KPI Z
  - KPI X ← KGI B の上にドロップすると最後に追加される
```

### 順序変更と階層移動の組み合わせ
```
元の状態:
- KGI A
  - KPI X
  - KPI Y
- KGI B
  - KPI Z

KPI X を KPI Z の前に移動:
- KGI A
  - KPI Y
- KGI B
  - KPI X ← KPI Z の上にドロップ
  - KPI Z
```

## 技術仕様

### 使用ライブラリ
- `@dnd-kit/core`: コアドラッグ&ドロップ機能
- `@dnd-kit/sortable`: ソート可能リスト機能
- `@dnd-kit/utilities`: ユーティリティ関数

### 主要コンポーネント
1. **DndContext** (`src/app/page.tsx`)
   - ドラッグ&ドロップのコンテキストプロバイダー
   - センサー設定（8pxの移動で有効化）
   - ドラッグイベントハンドラー

2. **SortableContext** (`src/components/TaskList.tsx`)
   - ソート可能なコンテキスト
   - 垂直リスト戦略

3. **SortableTaskItem** (`src/components/SortableTaskItem.tsx`)
   - 個別のソート可能タスク
   - ビジュアルフィードバック
   - 再帰的な子要素レンダリング

### データ構造
```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  completed: boolean;
  createdAt: string;
  updatedAt?: string;
  level: TaskLevel; // "kgi" | "kpi" | "kai"
  parentId?: string;
  children: Task[];
  order: number; // ドラッグ&ドロップの順序
}
```

## トラブルシューティング

### ドラッグが開始されない
- 最低8pxの移動が必要（誤操作防止）
- タスクカード以外の場所（ボタンなど）をドラッグしていないか確認

### ドロップできない
1. ビジュアルフィードバックを確認
   - 赤色 = ドロップ不可（制約違反）
   - 緑色 = ドロップ可能
2. レベル制約を確認
   - KGI → KPI の子には不可
   - KPI → KAI の子には不可
3. 自分の子孫にはドロップ不可

### タスクが重複する
- 子要素のレンダリングは `SortableTaskItem` のみが担当
- `TaskItem` では子要素をレンダリングしない

## 今後の拡張予定

- [ ] ドラッグハンドル（特定の領域のみドラッグ可能に）
- [ ] アニメーション速度のカスタマイズ
- [ ] キーボードナビゲーション対応
- [ ] タッチデバイスでの改善
- [ ] Undo/Redo機能との完全統合
